var aiConfig=editor.getOpt("ai"),aiFunctions=editor.getOpt("aiFunctions"),isMultiLine=function(t){return-1!==t.indexOf("\n")},fetchStream=function(t,e,a,u){fetch(t,Object.assign({method:"POST"},e)).then(t=>{if(t.ok){const e=t.body.getReader(),r=new TextDecoder("utf-8");let o="";const s=[];function n(t){o+=r.decode(t,{stream:!0});const e=o.split("\n");for(var i of e)if(i=i.trim(),i.startsWith("data:")){i=i.replace("data:","").trim();if("[DONE]"===i)return void u({code:0,msg:"ok",data:{text:s.join("")}});try{let t=null;var n=JSON.parse(i);if(n.choices&&0<n.choices.length&&n.choices[0].delta)t=n.choices[0].delta.content;else if(n.type){if("error"===n.type)return void u({code:-1,msg:n.data});if("end"===n.type)return void u({code:0,msg:"ok",data:{text:s.join("")}});"data"===n.type&&(t=n.data)}null!==t?(s.push(t),a({code:0,msg:"ok",data:{text:t}})):(u({code:-1,msg:"No text found!"}),console.log("data:",n))}catch(t){u({code:-1,msg:"JSON parse error!"+t})}}o=e.pop()||""}!function i(){e.read().then(({done:t,value:e})=>{t?o&&n(new Uint8Array):(n(e),i())}).catch(t=>{u({code:-1,msg:"Stream error!"+t})})}()}else u({code:-1,msg:`HTTP error! status: ${t.status}`})}).catch(t=>{u({code:-1,msg:"Request error!"+t})})},openAiCompletion=function(t,e,i){(i=Object.assign({body:null},i)).body||(i.body={model:aiConfig.driverConfig.model,messages:[{role:"user",content:e.promptText}],stream:!0}),fetchStream(t,{headers:{Authorization:`Bearer ${aiConfig.driverConfig.key}`,"Content-Type":"application/json"},body:JSON.stringify(i.body)},e.onStream,e.onFinish)},drivers={ModStart:function(t){openAiCompletion(aiConfig.driverConfig.url,t,{body:{prompt:t.promptText}})},OpenAi:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.openai.com/v1/engines/davinci/completions",t)},DeepSeek:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.deepseek.com/chat/completions",t)}};function getRequest(t){return aiConfig.driverRequest||(t in drivers?drivers[t]:null)}var converter=new window.showdown.Converter,Ai={runtime:{range:null},init:function(){new Vue({el:"#app",data:{loading:!1,selectText:"",inputText:"",promptText:"",resultText:"",resultError:"",functions:[]},mounted:function(){Ai.runtime.range=editor.selection.getRange();var t=Ai.runtime.range.cloneContents();this.selectText=t?t.textContent.trim():"",this.buildFunctions()},computed:{resultHtml:function(){return this.resultText?converter.makeHtml(this.resultText):""},resultHeight:function(){let t=255;return this.selectText&&(t-=45),this.resultError&&(t-=45),t+"px"}},methods:{buildFunctions:function(){var e={selectText:this.selectText};this.functions=aiFunctions.map(function(t){return t.enable(e)?(t.prompt=t.prompt.replace(/\{selectText\}/g,e.selectText),t):null}).filter(function(t){return!!t})},doSubmit:function(){var t;this.loading||(this.inputText&&(this.selectText?this.promptText=this.selectText+"\n\n"+this.inputText:this.promptText=this.inputText),this.promptText?(this.loading=!0,this.resultError="",this.resultText="",(t=getRequest(aiConfig.driver))?t({promptText:this.promptText,onStream:t=>{t.code?this.resultError=t.msg:this.resultText+=t.data.text},onFinish:t=>{this.loading=!1,t.code?this.resultError=t.msg:this.resultText=t.data.text}}):editor.tipError("未找到驱动")):editor.tipError("请输入内容"))},doSubmitFunction:function(t){this.promptText=t.prompt,this.doSubmit()},doInsert:function(){editor.fireEvent("saveScene"),this.selectText?isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)):isMultiLine(this.resultText)?editor.execCommand("insertHtml",this.resultHtml):editor.execCommand("insertHtml",this.resultText),dialog.close(!0)},doReplace:function(){editor.fireEvent("saveScene"),Ai.runtime.range.deleteContents(),isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)),dialog.close(!0)}}})}};utils.domReady(function(){Ai.init()});