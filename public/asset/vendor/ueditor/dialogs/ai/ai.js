var aiConfig=editor.getOpt("ai"),aiFunctions=[{text:'<i class="edui-iconfont edui-icon-magic-wand"></i> 翻译',prompt:"{selectText}\n\n请帮我翻译一下这段内容，并直接返回优化后的结果。\n注意：你应该先判断一下这句话是中文还是英文，如果是中文，请给我返回英文，如果是英文，请给我返回中文内容，只需要返回内容即可，不需要告知我是中文还是英文。",enable:function(e){return!!e.selectText}},{text:'<i class="edui-iconfont edui-icon-magic-wand"></i> 续写',prompt:"{selectText}\n\n请帮我续写一下这段内容，并直接返回续写后的结果。",enable:function(e){return!!e.selectText}},{text:'<i class="edui-iconfont edui-icon-magic-wand"></i> 简化内容',prompt:"{selectText}\n\n请帮我简化一下这段内容，并直接返回简化后的结果。",enable:function(e){return!!e.selectText}},{text:'<i class="edui-iconfont edui-icon-magic-wand"></i> 丰富内容',prompt:"{selectText}\n\n请帮我丰富一下这段内容，并直接返回丰富后的结果。",enable:function(e){return!!e.selectText}}],isMultiLine=function(e){return-1!==e.indexOf("\n")},fetchStream=function(e,t,c,a){fetch(e,Object.assign({method:"POST"},t)).then(e=>{if(e.ok){const t=e.body.getReader(),r=new TextDecoder("utf-8");let o="";const s=[];function n(e){o+=r.decode(e,{stream:!0});const t=o.split("\n");for(var i of t)if(i=i.trim(),i.startsWith("data:")){i=i.replace("data:","").trim();if("[DONE]"===i)return void a({code:0,msg:"ok",data:{text:s.join("")}});try{let e=null;var n=JSON.parse(i);if(n.choices&&0<n.choices.length&&n.choices[0].delta)e=n.choices[0].delta.content;else if(n.type){if("error"===n.type)return void a({code:-1,msg:n.data});if("end"===n.type)return void a({code:0,msg:"ok",data:{text:s.join("")}});"data"===n.type&&(e=n.data)}null!==e?(s.push(e),c({code:0,msg:"ok",data:{text:e}})):(a({code:-1,msg:"No text found!"}),console.log("data:",n))}catch(e){a({code:-1,msg:"JSON parse error!"+e})}}o=t.pop()||""}!function i(){t.read().then(({done:e,value:t})=>{e?o&&n(new Uint8Array):(n(t),i())}).catch(e=>{a({code:-1,msg:"Stream error!"+e})})}()}else a({code:-1,msg:`HTTP error! status: ${e.status}`})}).catch(e=>{a({code:-1,msg:"Request error!"+e})})},openAiCompletion=function(e,t,i){(i=Object.assign({body:null},i)).body||(i.body={model:aiConfig.driverConfig.model,messages:[{role:"user",content:t.promptText}],stream:!0}),fetchStream(e,{headers:{Authorization:`Bearer ${aiConfig.driverConfig.key}`,"Content-Type":"application/json"},body:JSON.stringify(i.body)},t.onStream,t.onFinish)},drivers={ModStart:function(e){openAiCompletion(aiConfig.driverConfig.url,e,{body:{prompt:e.promptText}})},OpenAi:function(e){openAiCompletion(aiConfig.driverConfig.url||"https://api.openai.com/v1/engines/davinci/completions",e)},DeepSeek:function(e){openAiCompletion(aiConfig.driverConfig.url||"https://api.deepseek.com/chat/completions",e)}};function getRequest(e){return aiConfig.driverRequest||(e in drivers?drivers[e]:null)}var converter=new window.showdown.Converter,Ai={runtime:{range:null},init:function(){new Vue({el:"#app",data:{loading:!1,selectText:"",inputText:"",promptText:"",resultText:"",resultError:"",functions:[]},mounted:function(){Ai.runtime.range=editor.selection.getRange();var e=Ai.runtime.range.cloneContents();this.selectText=e?e.textContent.trim():"",this.buildFunctions()},computed:{resultHtml:function(){return this.resultText?converter.makeHtml(this.resultText):""},resultHeight:function(){let e=255;return this.selectText&&(e-=45),this.resultError&&(e-=45),e+"px"}},methods:{buildFunctions:function(){var t={selectText:this.selectText};this.functions=aiFunctions.map(function(e){return e.enable(t)?(e.prompt=e.prompt.replace(/\{selectText\}/g,t.selectText),e):null}).filter(function(e){return!!e})},doSubmit:function(){var e;this.loading||(this.inputText&&(this.promptText=this.inputText),this.promptText?(this.loading=!0,this.resultError="",this.resultText="",(e=getRequest(aiConfig.driver))?e({promptText:this.promptText,onStream:e=>{e.code?this.resultError=e.msg:this.resultText+=e.data.text},onFinish:e=>{this.loading=!1,e.code?this.resultError=e.msg:this.resultText=e.data.text}}):editor.tipError("未找到驱动")):editor.tipError("请输入内容"))},doSubmitFunction:function(e){this.promptText=e.prompt,this.doSubmit()},doInsert:function(){editor.fireEvent("saveScene"),this.selectText?isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)):isMultiLine(this.resultText)?editor.execCommand("insertHtml",this.resultHtml):editor.execCommand("insertHtml",this.resultText),dialog.close(!0)},doReplace:function(){editor.fireEvent("saveScene"),Ai.runtime.range.deleteContents(),isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)),dialog.close(!0)}}})}};utils.domReady(function(){Ai.init()});